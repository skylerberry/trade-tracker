<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>Trade Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Trade Management Dashboard</h1>
            <div class="header-actions">
                <div class="sync-status" id="syncStatus" role="button" tabindex="0" aria-label="Sync settings">
                    <svg class="sync-icon icon-cloud" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                    </svg>
                    <svg class="sync-icon icon-cloud-off" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                    <span class="sync-text"></span>
                </div>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <section class="calculator-section">
            <button id="toggleCalculatorBtn" class="btn btn-calculator">Position Calculator</button>

            <div id="calculatorPanel" class="calculator-panel hidden">
                <h2>Position Size Calculator</h2>

                <!-- Settings Header -->
                <div class="calc-settings-header">
                    <div class="setting-item">
                        <label for="calcAccountSize">Account:</label>
                        <input type="text" id="calcAccountSize" placeholder="e.g., 50k" autocomplete="off">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Risk:</span>
                        <div class="preset-buttons">
                            <button type="button" class="preset-btn risk-preset" data-value="0.1" tabindex="-1">.1%</button>
                            <button type="button" class="preset-btn risk-preset" data-value="0.25" tabindex="-1">.25%</button>
                            <button type="button" class="preset-btn risk-preset" data-value="0.5" tabindex="-1">.5%</button>
                            <button type="button" class="preset-btn risk-preset active" data-value="1" tabindex="-1">1%</button>
                            <button type="button" class="preset-btn custom-toggle" id="customRiskToggle" tabindex="-1">Custom</button>
                            <span class="custom-input-wrapper hidden" id="customRiskWrapper"><input type="text" id="calcCustomRisk" class="custom-preset-input" autocomplete="off" tabindex="-1">%</span>
                        </div>
                        <button type="button" class="set-default-btn" id="setDefaultRisk" tabindex="-1">Set as default</button>
                        <input type="number" id="calcRiskPercent" step="0.1" value="1" min="0.1" max="100" class="hidden">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Max:</span>
                        <div class="preset-buttons">
                            <button type="button" class="preset-btn max-preset" data-value="5" tabindex="-1">5%</button>
                            <button type="button" class="preset-btn max-preset" data-value="10" tabindex="-1">10%</button>
                            <button type="button" class="preset-btn max-preset" data-value="20" tabindex="-1">20%</button>
                            <button type="button" class="preset-btn max-preset" data-value="50" tabindex="-1">50%</button>
                            <button type="button" class="preset-btn max-preset active" data-value="100" tabindex="-1">100%</button>
                            <button type="button" class="preset-btn custom-toggle" id="customMaxToggle" tabindex="-1">Custom</button>
                            <span class="custom-input-wrapper hidden" id="customMaxWrapper"><input type="text" id="calcCustomMax" class="custom-preset-input" autocomplete="off" tabindex="-1">%</span>
                        </div>
                        <button type="button" class="set-default-btn" id="setDefaultMax" tabindex="-1">Set as default</button>
                        <input type="number" id="calcMaxPercent" step="1" value="100" min="1" max="100" class="hidden">
                    </div>
                </div>

                <!-- Inputs Row -->
                <div class="calc-inputs-row">
                    <div class="form-group">
                        <label for="calcEntryPrice">Entry Price</label>
                        <div class="input-with-buttons">
                            <input type="number" id="calcEntryPrice" step="0.01" placeholder="0.00" autocomplete="off">
                            <div class="increment-btn-stack">
                                <button type="button" class="increment-btn increment-btn-top" data-target="calcEntryPrice" data-delta="0.01" tabindex="-1">+</button>
                                <button type="button" class="increment-btn increment-btn-bottom" data-target="calcEntryPrice" data-delta="-0.01" tabindex="-1">-</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="calcStopLoss">Stop Loss</label>
                        <div class="input-with-buttons">
                            <input type="number" id="calcStopLoss" step="0.01" placeholder="0.00" autocomplete="off">
                            <div class="increment-btn-stack">
                                <button type="button" class="increment-btn increment-btn-top" data-target="calcStopLoss" data-delta="0.01" tabindex="-1">+</button>
                                <button type="button" class="increment-btn increment-btn-bottom" data-target="calcStopLoss" data-delta="-0.01" tabindex="-1">-</button>
                            </div>
                            <button type="button" class="btn-copy-input" id="copyCalcStopLoss" title="Copy to clipboard" tabindex="-1"><span class="copy-text">Copy</span><svg class="copy-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
                        </div>
                        <span class="calc-error hidden" id="calcStopLossError">Stop loss must be below entry price</span>
                    </div>
                    <div class="form-group target-group">
                        <label for="calcTargetPrice">Target Price <span class="optional-tag">optional</span></label>
                        <div class="input-with-buttons">
                            <input type="number" id="calcTargetPrice" step="0.01" placeholder="0.00" autocomplete="off">
                            <div class="increment-btn-stack">
                                <button type="button" class="increment-btn increment-btn-top" data-target="calcTargetPrice" data-delta="0.01" tabindex="-1">+</button>
                                <button type="button" class="increment-btn increment-btn-bottom" data-target="calcTargetPrice" data-delta="-0.01" tabindex="-1">-</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards Row -->
                <div class="calc-cards-row">
                    <div class="calc-result-card">
                        <div class="calc-big-result">
                            <span class="calc-big-value" id="calcShares">-</span>
                            <span class="calc-big-label">shares</span>
                        </div>
                        <div class="calc-result-list">
                            <div class="calc-result-row">
                                <span>Stop Distance</span>
                                <span id="calcStopDistance">-</span>
                            </div>
                            <div class="calc-result-row">
                                <span>Position Size</span>
                                <span id="calcPositionSize">-</span>
                            </div>
                            <div class="calc-result-row">
                                <span>Total Risk</span>
                                <span id="calcTotalRisk">-</span>
                            </div>
                            <div class="calc-result-row">
                                <span>% of Account</span>
                                <span id="calcPercentAccount">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="calc-target-card">
                        <div class="calc-target-header">At Target (<span id="calcRMultiple">-</span>)</div>
                        <div class="calc-target-big-value" id="calcTargetProfit">-</div>
                        <div class="calc-target-list">
                            <div class="calc-target-row">
                                <span>Target Price</span>
                                <span id="calcTargetPriceDisplay">-</span>
                            </div>
                            <div class="calc-target-row">
                                <span>Profit Per Share</span>
                                <span id="calcProfitPerShare">-</span>
                            </div>
                            <div class="calc-target-row">
                                <span>ROI</span>
                                <span id="calcROI">-</span>
                            </div>
                            <div class="calc-target-row">
                                <span>R/R Multiple</span>
                                <span id="calcRRMultiple">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R-Levels Bar -->
                <div class="calc-r-levels">
                    <div class="r-level-item" data-r="1">
                        <div class="r-label">1R</div>
                        <div class="r-price" id="r1Price">-</div>
                        <div class="r-profit" id="r1Profit">-</div>
                    </div>
                    <div class="r-level-item" data-r="2">
                        <div class="r-label">2R</div>
                        <div class="r-price" id="r2Price">-</div>
                        <div class="r-profit" id="r2Profit">-</div>
                    </div>
                    <div class="r-level-item" data-r="3">
                        <div class="r-label">3R</div>
                        <div class="r-price" id="r3Price">-</div>
                        <div class="r-profit" id="r3Profit">-</div>
                    </div>
                    <div class="r-level-item" data-r="4">
                        <div class="r-label">4R</div>
                        <div class="r-price" id="r4Price">-</div>
                        <div class="r-profit" id="r4Profit">-</div>
                    </div>
                    <div class="r-level-item" data-r="5">
                        <div class="r-label">5R</div>
                        <div class="r-price" id="r5Price">-</div>
                        <div class="r-profit" id="r5Profit">-</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="add-trade-section">
            <button id="toggleFormBtn" class="btn btn-primary">+ Add New Trade</button>

            <form id="tradeForm" class="trade-form hidden" autocomplete="off">
                <h2 id="formTitle">Add New Trade</h2>
                <input type="hidden" id="tradeId">

                <div class="form-grid">
                    <div class="form-group">
                        <label for="ticker">Ticker</label>
                        <div class="input-with-icon">
                            <span class="input-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
                            </span>
                            <input type="text" id="ticker" required placeholder="e.g., AAPL">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="entryPrice">Entry Price</label>
                        <div class="input-with-icon">
                            <span class="input-icon">$</span>
                            <input type="number" id="entryPrice" step="0.01" required placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="entryDate">Entry Date</label>
                        <div class="input-with-icon">
                            <span class="input-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            </span>
                            <input type="text" id="entryDate" class="datepicker" required placeholder="Select date">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="initialSL">Initial Stop Loss</label>
                        <div class="input-with-icon">
                            <span class="input-icon">$</span>
                            <input type="number" id="initialSL" step="0.01" required placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="currentSL">Current Stop Loss <button type="button" id="copyInitialSL" class="btn-copy" title="Copy from Initial SL">= Initial</button></label>
                        <div class="input-with-icon">
                            <span class="input-icon">$</span>
                            <input type="number" id="currentSL" step="0.01" required placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <div class="input-with-icon">
                            <span class="input-icon">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </span>
                            <select id="status">
                                <option value="open">Open</option>
                                <option value="partially_closed">Partially Closed</option>
                                <option value="closed">Fully Closed</option>
                                <option value="stopped_out">Stopped Out</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h3>Sales</h3>
                <div id="salesContainer" class="sales-container"></div>
                <button type="button" id="addSaleBtn" class="btn btn-add-sale">+ Add Sale</button>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Trade</button>
                    <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </section>

        <section class="filters-section">
            <div class="filter-group">
                <label for="statusFilter">Filter by Status:</label>
                <select id="statusFilter">
                    <option value="all">All Trades</option>
                    <option value="open">Open</option>
                    <option value="partially_closed">Partially Closed</option>
                    <option value="closed">Fully Closed</option>
                    <option value="stopped_out">Stopped Out</option>
                </select>
            </div>
            <button id="exportPdfBtn" class="btn btn-export">Export Open Trades to PDF</button>
            <button id="gistSettingsBtn" class="btn btn-settings">Sync Settings</button>
        </section>

        <!-- Gist Settings Modal -->
        <div id="gistModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="gistModalTitle">
            <div class="modal-content">
                <button type="button" id="closeGistModal" class="btn-modal-close" aria-label="Close">&times;</button>
                <h2 id="gistModalTitle">GitHub Gist Sync</h2>
                <div id="gistSetup">
                    <p>Sync your trades easily across devices using GitHub Gist.</p>

                    <details class="help-section">
                        <summary>How to get a token (first time setup)</summary>
                        <ol class="help-steps">
                            <li>Click the <a href="https://github.com/settings/tokens/new?scopes=gist&description=Trade%20Tracker" target="_blank">Create token</a> link below</li>
                            <li>Log in to GitHub if prompted</li>
                            <li>Set expiration to <strong>"No expiration"</strong> (recommended)</li>
                            <li>The "gist" checkbox should already be selected</li>
                            <li>Click <strong>"Generate token"</strong> at the bottom</li>
                            <li>Copy the token (starts with <code>ghp_</code>)</li>
                            <li>Paste it below and click "Save & Sync"</li>
                        </ol>
                        <p class="help-note">On a new device? Enter the same token and your Gist ID to sync existing trades.</p>
                    </details>

                    <div class="form-group">
                        <label for="gistToken">GitHub Personal Access Token</label>
                        <input type="password" id="gistToken" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
                        <small>Needs "gist" scope. <a href="https://github.com/settings/tokens/new?scopes=gist&description=Trade%20Tracker" target="_blank">Create token</a></small>
                    </div>
                    <div class="form-group" id="gistIdGroup">
                        <label for="gistId">Gist ID <span class="optional-label">(leave empty for new setup)</span></label>
                        <input type="text" id="gistId" placeholder="Only needed to sync existing trades" autocomplete="off">
                    </div>
                    <div class="modal-actions">
                        <button id="saveGistSettings" class="btn btn-primary">Save & Sync</button>
                        <button id="cancelGistSettings" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
                <div id="gistConnected" class="hidden">
                    <p class="sync-connected">Connected to GitHub Gist</p>
                    <p class="gist-id-display">Gist ID: <code id="displayGistId"></code><button type="button" id="copyGistId" class="btn-copy-gist" title="Copy Gist ID" aria-label="Copy Gist ID">
                        <svg class="icon-copy" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        <svg class="icon-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button></p>
                    <p class="last-synced-display">Last synced: <span id="lastSyncedDisplay">Never</span></p>
                    <div class="modal-actions">
                        <button id="forceSyncBtn" class="btn btn-primary">Sync Manually</button>
                        <button id="disconnectGist" class="btn btn-delete">Unlink</button>
                    </div>
                </div>
            </div>
        </div>

        <section class="trades-section">
            <div class="table-container">
                <table id="tradesTable">
                    <thead>
                        <tr>
                            <th scope="col">Ticker</th>
                            <th scope="col">Entry Price</th>
                            <th scope="col">Entry Date</th>
                            <th scope="col">Initial SL</th>
                            <th scope="col">Current SL</th>
                            <th scope="col">Sale 1</th>
                            <th scope="col">Sale 2</th>
                            <th scope="col">Sale 3</th>
                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tradesBody">
                    </tbody>
                </table>
            </div>
            <p id="noTrades" class="no-trades hidden">No trades logged yet. Click "Add New Trade" to get started.</p>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
